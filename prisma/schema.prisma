// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  // The path will be set programmatically in your Electron main process
  url      = "file:./dev.db"
}

enum UserRole {
  ADMIN
  CAISSIER
  COMPTABLE
  GERANT
  MAGASINIER
  CHEF_RAYON
  SERVEUR
}

enum EntrepriseType {
  COMMERCANT
  FOURNISSEUR
}

model User {
  id                String            @id @default(uuid())
  nom               String?
  prenom            String?
  telephone         String?
  pin               String            @default("0000")
  role              UserRole          @default(ADMIN)
  isActive          Boolean           @default(true)
  magasinId         String?
  fondcaisse        Decimal?
  email             String?
  entrepriseId      String?
  entreprise        Entreprise?       @relation(fields: [entrepriseId], references: [id])
  isBootstrap       Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  magasin           Magasin?          @relation("UserMagasinEmployees", fields: [magasinId], references: [id], onDelete: SetNull)
  magasins          Magasin[]         @relation("UserMagasins")
  createdCategories Categorie[]       @relation("CategorieCreatedBy")
  updatedCategories Categorie[]       @relation("CategorieUpdatedBy")
  permissions       String            @default("")
  isDefaultAdmin    Boolean?          @default(false)
  printer           Printer?          @relation
  assignedTables    Table[]           @relation("TableServer")
  commandes         Commande[]
  usedTicketRestos  UsedTicketResto[] @relation("UserToUsedTicketResto")

  retours Retour[] // Relation avec les retours
  ventes  Vente[] // Relation avec les ventes

  @@unique([pin])
}

model Entreprise {
  id                  String               @id @default(uuid())
  nom                 String?
  denomination        String?
  matriculeFiscale    String?
  adresse             String?
  telephone           String?
  logo                String?
  email               String?
  region              String?
  ville               String?
  pays                String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  type                EntrepriseType       @default(FOURNISSEUR)
  hasEpicerieModule   Boolean              @default(false)
  hasRestaurantModule Boolean              @default(false)
  secteurActivite     String?
  User                User[]
  categories          Categorie[]
  produits            Produit[]
  magasins            Magasin[]
  magasinProduits     MagasinProduit[]
  accs                Acc[]
  inventaires         Inventaire[]
  mouvementStocks     MouvementStock[]
  typeCharges         TypeCharge[]
  charges             Charge[]
  factures            Facture[]
  ventesFactures      VentesFacture[]
  achatFournisseurs   AchatFournisseur[]
  entrees             Entree[]
  myFactures          MyFacture[]
  myFactureAdresses   MyFactureAdresse[]
  myFactureEmails     MyFactureEmail[]
  myFactureTelephones MyFactureTelephone[]
  myFactureMobiles    MyFactureMobile[]
  balanceConfigs      BalanceConfig[]
  printers            Printer[]
  tables              Table[]
  floorPlans          FloorPlan[]
  commandes           Commande[]
  ventes              Vente[]
  remiseQRConfigs     RemiseQRConfig[] 
  ticketrestos        TicketResto[]
  usedTicketRestos    UsedTicketResto[]
  fournisseurs        Fournisseur[]
  clients             Client[]
  retours             Retour[]
  retourLignes        RetourLigne[]
}

model Categorie {
  id                String     @id @default(uuid())
  nom               String
  showInPos         Boolean    @default(false)
  isDefaultOperator Boolean    @default(false)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  createdById       String?
  createdBy         User?      @relation("CategorieCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedById       String?
  updatedBy         User?      @relation("CategorieUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  produits          Produit[]
  entrepriseId      String // Relation inverse
  entreprise        Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([nom])
}

model Lot {
  id        String  @id @default(uuid())
  quantite  Float
  price     Decimal
  produitId String
  produit   Produit @relation(fields: [produitId], references: [id])
}

model Magasin {
  id              String           @id @default(uuid())
  nom             String
  adresse         String?
  secteurActivite String
  region          String
  ville           String
  pays            String
  responsableId   String
  responsable     User             @relation("UserMagasins", fields: [responsableId], references: [id], onDelete: Cascade)
  employees       User[]           @relation("UserMagasinEmployees")
  magasinProduits MagasinProduit[]
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  entrepriseId    String? // Relation inverse
  entreprise      Entreprise?      @relation(fields: [entrepriseId], references: [id])
  productVariantStocks ProductVariantStock[]
  @@unique([nom])
}

model MagasinProduit {
  id            String     @id @default(uuid())
  produitId     String
  produit       Produit    @relation(fields: [produitId], references: [id], onDelete: Cascade)
  magasinId     String
  magasin       Magasin    @relation(fields: [magasinId], references: [id], onDelete: Cascade)
  quantite      Float
  stockInitial  Float
  stockSecurite Float?
  active        Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  entrepriseId  String // Relation inverse
  entreprise    Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([produitId, magasinId])
}

model Inventaire {
  id           String     @id @default(uuid())
  codeBarre    String
  designation  String
  quantite     Float
  responsable  String
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Acc {
  id           String     @id @default(uuid())
  codeBarre    String
  designation  String
  quantite     Float
  responsable  String
  remarque     String?
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model MouvementStock {
  id                String     @id @default(uuid())
  date              DateTime
  codeBarre         String
  designation       String
  stockInitial      Float
  stockSecurite     Float?
  achats            Float
  ventes            Float
  acc               Float
  retour            Float      @default(0)
  stockFinalTheoric Float
  stockFinalReal    Float?
  ecart             Float?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  entrepriseId      String // Relation inverse
  entreprise        Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([date, codeBarre])
}

model TypeCharge {
  id           String     @id @default(uuid())
  nom          String
  charges      Charge[]   @relation("ChargeToTypeCharge")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([nom])
}

model Charge {
  id                   String     @id @default(uuid())
  typeChargeId         String
  typeCharge           TypeCharge @relation("ChargeToTypeCharge", fields: [typeChargeId], references: [id], onDelete: Restrict)
  montant              Decimal
  dateEcheance         DateTime
  datePaiement         DateTime?
  dateDebutRepartition DateTime
  dateFinRepartition   DateTime
  paye                 Boolean    @default(false)
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  entrepriseId         String // Relation inverse
  entreprise           Entreprise @relation(fields: [entrepriseId], references: [id])
}

enum FactureType {
  FACTURE
  BDC
  DEV
}

model Facture {
  id                     String          @id @default(uuid())
  type                   FactureType
  num                    String          @unique(map: "UniqueFactureNum") // Correction du conflit
  dateEmission           DateTime        @default(now())
  dateEcheance           DateTime
  denominationClient     String
  matriculeFiscaleClient String?
  adresseClient          String
  clientTelephone        String?
  totalHT                Decimal
  totalTVA               Decimal
  timbreFiscal           Decimal?
  remise                 Decimal?        @default(0)
  totalNet               Decimal
  denomination           String
  matriculeFiscale       String
  banque                 String
  rib                    String
  logo                   String?
  ventesFactures         VentesFacture[] @relation("FactureVentes")
  entrepriseId           String // Relation inverse
  entreprise             Entreprise      @relation(fields: [entrepriseId], references: [id])
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
}

model VentesFacture {
  id           String     @id @default(uuid())
  factureId    String
  facture      Facture    @relation("FactureVentes", fields: [factureId], references: [id], onDelete: Cascade)
  codeBarre    String
  designation  String
  puht         Decimal
  tva          Decimal    @default(0)
  remise       Decimal    @default(0)
  quantite     Float
  totalHT      Decimal
  totalTTC     Decimal
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])
}

model AchatFournisseur {
  id              String     @id @default(uuid())
  numeroFacture   String
  fournisseur     String
  dateEcheance    DateTime
  datePaiement    DateTime?
  pieceJointe     String?
  montantTotal    Decimal
  montantComptant Decimal?
  montantRestant  Decimal?
  remise          Decimal?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  entrees         Entree[]   @relation("AchatFournisseurToEntree")
  entrepriseId    String // Relation inverse
  entreprise      Entreprise @relation(fields: [entrepriseId], references: [id])
}

model Entree {
  id                 String            @id @default(uuid())
  codeBarre          String
  designation        String
  quantite           Float
  puht               Decimal
  tva                Decimal
  prixUnitaireTTC    Decimal
  prixTotalTTC       Decimal
  achatFournisseurId String?
  achatFournisseur   AchatFournisseur? @relation("AchatFournisseurToEntree", fields: [achatFournisseurId], references: [id], onDelete: SetNull)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  entrepriseId       String // Relation inverse
  entreprise         Entreprise        @relation(fields: [entrepriseId], references: [id])
}

model MyFacture {
  id               String               @id @default(uuid())
  denomination     String
  matriculeFiscale String
  banque           String
  rib              String
  logo             String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  adresses         MyFactureAdresse[]
  emails           MyFactureEmail[]
  telephones       MyFactureTelephone[]
  mobiles          MyFactureMobile[]
  entrepriseId     String // Relation inverse
  entreprise       Entreprise           @relation(fields: [entrepriseId], references: [id])

  @@unique([denomination])
}

model MyFactureAdresse {
  id           String     @id @default(uuid())
  adresse      String
  myFactureId  String
  myFacture    MyFacture  @relation(fields: [myFactureId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([adresse, myFactureId]) // Ensures unique addresses per MyFacture
}

model MyFactureEmail {
  id           String     @id @default(uuid())
  email        String
  myFactureId  String
  myFacture    MyFacture  @relation(fields: [myFactureId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([email, myFactureId]) // Ensures unique emails per MyFacture
}

model MyFactureTelephone {
  id           String     @id @default(uuid())
  numTel       String
  myFactureId  String
  myFacture    MyFacture  @relation(fields: [myFactureId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([numTel, myFactureId]) // Ensures unique telephone numbers per MyFacture
}

model MyFactureMobile {
  id           String     @id @default(uuid())
  numMobile    String
  myFactureId  String
  myFacture    MyFacture  @relation(fields: [myFactureId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([numMobile, myFactureId]) // Ensures unique mobile numbers per MyFacture
}

model BalanceConfig {
  id                Int        @id @default(autoincrement())
  barcodeLength     Int
  balanceCode       String
  productCodeStart  Int
  productCodeLength Int
  priceStart        Int
  priceLength       Int
  sellerStart       Int? // optional
  sellerLength      Int? // optional
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  entrepriseId      String // Relation inverse
  entreprise        Entreprise @relation(fields: [entrepriseId], references: [id])
}

model Printer {
  id           String     @id @default(uuid())
  name         String
  userId       String?    @unique
  user         User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([name])
}

model Commande {
  id           String     @id @default(uuid())
  date         DateTime   @default(now())
  total        Decimal
  userId       String
  user         User       @relation(fields: [userId], references: [id], onDelete: Restrict)
  isWaiting    Boolean    @default(false)
  tpeAmount    Decimal    @default(0.000)
  especeAmount Decimal    @default(0.000)
  ticketAmount Decimal    @default(0.000)
  ticketNumber String?    @unique
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @default(now())
  ventes       Vente[]
  tableId      String?
  table        Table?     @relation("TableCommandes", fields: [tableId], references: [id], onDelete: SetNull)
  remise       Decimal?   @default(0)
  chequeAmount Decimal    @default(0.000)
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])
  annule       Boolean    @default(false)

  // Relation bidirectionnelle corrig√©e
  retours Retour[] @relation("CommandeRetours")
}

model Vente {
  id             String        @id @default(uuid())
  codeBarre      String
  designation    String
  puht           Decimal
  tva            Decimal       @default(0)
  remise         Decimal       @default(0)
  ticketsRemise  TicketRemiseQR[] 
  quantite       Float
  totalHT        Decimal
  totalTTC       Decimal
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  commandeId     String
  commande       Commande      @relation(fields: [commandeId], references: [id])
  entrepriseId   String
  entreprise     Entreprise    @relation(fields: [entrepriseId], references: [id])
  retourQuantite Float         @default(0)
  retourLignes   RetourLigne[]
  cloturee       Boolean       @default(false)
  clotureId      Int?
  userId         String?
  user           User?         @relation(fields: [userId], references: [id])
  
 
  statut         String        @default("PAYEE")  
  caissier       String?       
  paiements      Paiement[]    
  
  @@index([caissier])
  @@index([statut])
  @@index([createdAt])
  @@index([cloturee])
}

model Retour {
  id           String        @id @default(cuid())
  commandeId   String
  commande     Commande      @relation("CommandeRetours", fields: [commandeId], references: [id])
  totalRetour  Float
  entrepriseId String
  entreprise   Entreprise    @relation(fields: [entrepriseId], references: [id])
  userId       String
  user         User          @relation(fields: [userId], references: [id])
  lignes       RetourLigne[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([commandeId])
  @@index([entrepriseId])
  @@index([userId])
}

model RetourLigne {
  id           String     @id @default(uuid())
  venteId      String
  vente        Vente      @relation(fields: [venteId], references: [id], onDelete: Cascade)
  quantite     Float
  montant      Decimal
  createdAt    DateTime   @default(now())
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])
  retour       Retour?    @relation(fields: [retourId], references: [id], onDelete: Cascade)
  retourId     String?
}

model Table {
  id           String     @id @default(uuid())
  number       String // Table number (e.g., "Table 1", "T1")
  serverId     String? // Optional server (User with SERVEUR role)
  server       User?      @relation("TableServer", fields: [serverId], references: [id], onDelete: SetNull)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  commandes    Commande[] @relation("TableCommandes") // Orders placed at this table
  floorPlanId  String? // Optional link to the floor plan
  floorPlan    FloorPlan? @relation("FloorPlanTables", fields: [floorPlanId], references: [id], onDelete: SetNull)
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([number]) // Unique table number
}

model FloorPlan {
  id           String     @id @default(uuid())
  name         String // Name of the floor plan (e.g., "Main Dining", "Terrace")
  elements     Json // JSON array of elements (type, label, x, y, width, height, etc.)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  tables       Table[]    @relation("FloorPlanTables") // Tables associated with this floor plan
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([name]) // Unique floor plan name
}

model TicketResto {
  id           String     @id @default(uuid())
  fournisseur  String
  codeInterne  String
  pourcentage  Float?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  entrepriseId String // Relation inverse
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([codeInterne])
}

model UsedTicketResto {
  id           String     @id @default(uuid())
  codeBarre    String     @unique
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  userId       String?
  user         User?      @relation("UserToUsedTicketResto", fields: [userId], references: [id], onDelete: SetNull)
}

model Fournisseur {
  id           String     @id @default(uuid())
  mails        String
  fixedTel     String
  mobileTel    String
  denomination String     @unique
  matricule    String
  secteur      String
  rib          String
  addresses    String
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}

model Client {
  id           String     @id @default(uuid())
  nom          String
  prenom       String
  cin          Int
  email        String?
  address      String?
  tel          String     @unique
  credit       Float      @default(0)
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])
  entrepriseId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
}
model ClotureJour {
  id                     Int                     @id @default(autoincrement())
  dateFermeture          DateTime
  heureFermeture         String?
  caissierResponsable    String
  chiffreAffaires        Float                   @default(0)
  totalEncaissements     Float                   @default(0)
  totalAchat             Float                   @default(0)
  totalCharge            Float                   @default(0)
  totalAcc               Float                   @default(0)
  totalRemises           Float                   @default(0)
  totalRetours           Float                   @default(0)
  totalNet               Float                   @default(0)
  nombreVentes           Int                     @default(0)
  tvaCollecte            Float                   @default(0)
  fondCaisseInitial      Float                   @default(0)
  totalEspecesEncaiss√©es Float                   @default(0)
  totalEspecesSorties    Float                   @default(0)
  totalEspecesEntree     Float                   @default(0)
  totalEspecesFinalAttendu Float                 @default(0)
  statut                 String                  @default("TERMINEE")
  ventesCaissiers        VenteCaissierCloture[]
  detailPaiements        DetailPaiementCloture[]
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  
  @@index([dateFermeture])
  @@index([caissierResponsable])
}

model VenteCaissierCloture {
  id                   Int     @id @default(autoincrement())
  clotureId            Int
  cloture              ClotureJour @relation(fields: [clotureId], references: [id], onDelete: Cascade)
  nomCaissier          String
  nombreVentes         Int     @default(0)
  montantTotal         Float   @default(0)
  totalRetours         Float   @default(0)
  fondCaisse           Float   @default(0)
  totalRemises         Float   @default(0)
  totalNet             Float   @default(0)
  totalEncaissements   Float   @default(0)
  paiementsEspeces     Float   @default(0)
  paiementsCarte       Float   @default(0)
  paiementsCheque      Float   @default(0)
  paiementsTicket      Float   @default(0)
  
  @@index([clotureId])
  @@index([nomCaissier])
}

model DetailPaiementCloture {
  id           Int     @id @default(autoincrement())
  clotureId    Int
  cloture      ClotureJour @relation(fields: [clotureId], references: [id], onDelete: Cascade)
  typePaiement String
  montant      Float   @default(0)
  
  @@index([clotureId])
  @@index([typePaiement])
}
model Paiement {
  id             String    @id @default(uuid())
  type           String    // ESPECES, CARTE, CHEQUE, TICKET_RESTAURANT, VIREMENT
  montant        Decimal
  venteId        String
  vente          Vente     @relation(fields: [venteId], references: [id], onDelete: Cascade)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  @@index([venteId])
  @@index([type])
}

enum ProductType {
  POS
  MAGASIN
}

model Produit {
  id                String        @id @default(uuid())
  codeBarre         String        @unique
  designation       String

  parentId          String?
  parent            Produit?      @relation("ProductParent", fields: [parentId], references: [id])
  children          Produit[]     @relation("ProductParent")

  categorieId       String
  categorie         Categorie     @relation(fields: [categorieId], references: [id], onDelete: Restrict)

  entrepriseId      String
  entreprise        Entreprise    @relation(fields: [entrepriseId], references: [id])

  puht              Decimal
  tva               Decimal       @default(0)
  remise            Decimal       @default(0)
  dateDebutRemise   DateTime?
  dateFinRemise     DateTime?

  stockInitial      Float
  quantite          Float         @default(1)
  stockSecurite     Float?

  featuredOnPos     Boolean       @default(false)
  active            Boolean       @default(true)
  isDefaultOperator Boolean       @default(false)
  type              ProductType   @default(MAGASIN)

  imagePath         String?

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  magasinProduits   MagasinProduit[]
  Lot               Lot[]

  variants          ProductVariant[]

  @@map("produits")
}

model VariantFamily {
  id          Int            @id @default(autoincrement())
  name        String         @unique
  description String?
  code        String         @unique
  isRequired  Boolean        @default(false)
  sortOrder   Int            @default(0)
  values      VariantValue[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@map("variant_families")
}

model VariantValue {
  id              Int              @id @default(autoincrement())
  value           String
  sortOrder       Int              @default(0)

  variantFamilyId Int?
  variantFamily   VariantFamily?    @relation(fields: [variantFamilyId], references: [id], onDelete: Cascade)

  // üîß OBLIGATOIRE POUR PRISMA (legacy)
  productVariants ProductVariant[] @relation("variant_values")

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([variantFamilyId, value])
  @@map("variant_values")
}

model ProductVariant {
  id                 Int                     @id @default(autoincrement())
  productId          String
  product            Produit                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku                String?                 @unique  // SKU unique pour cette variante
  name               String?                 // Nom affichable (ex: "iPhone 13 - Rouge - 128GB")
  priceAdjustment    Float                   @default(0) // Ajustement de prix par rapport au produit de base
  costAdjustment     Float                   @default(0) // Ajustement de co√ªt
  isActive           Boolean                 @default(true)
  values             VariantValue[]          @relation("variant_values")
  stocks             ProductVariantStock[]   // Stocks par magasin
  // saleItems          SaleItem[]            // √Ä activer plus tard quand le mod√®le SaleItem sera cr√©√©
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt

  @@map("product_variants")
}
model ProductVariantStock {
  id                Int            @id @default(autoincrement())
  productVariantId  Int
  productVariant    ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  magasinId         String         // doit correspondre au type de Magasin.id
  magasin           Magasin        @relation(fields: [magasinId], references: [id])
  quantity          Int            @default(0)
  minStock          Int            @default(0)
  maxStock          Int?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @default(now()) @updatedAt

  @@unique([productVariantId, magasinId])
  @@map("product_variant_stocks")
}

model RemiseQRConfig {
  id           String        @id @default(uuid())
  entrepriseId String
  entreprise   Entreprise    @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  pourcentage  Float
  joursValidite Int
  isActive     Boolean       @default(true)
  message      String?       @default("Revenez prochainement pour b√©n√©ficier d'une remise!")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  ticketsRemise TicketRemiseQR[]
  
  @@unique([entrepriseId, isActive])
  @@map("remise_qr_configs")
}

model TicketRemiseQR {
  id              String        @id @default(uuid())
  code            String        @unique
  configId        String
  config          RemiseQRConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  venteId         String?
  vente           Vente?        @relation(fields: [venteId], references: [id], onDelete: SetNull)
  pourcentage     Float
  dateExpiration  DateTime
  dateUtilisation DateTime?
  isUsed          Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([code])
  @@index([venteId])
  @@index([dateExpiration])
  @@index([isUsed])
  @@map("ticket_remise_qr")
}