// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

enum UserRole {
  ADMIN
  CAISSIER
  COMPTABLE
  GERANT
  MAGASINIER
  CHEF_RAYON
  SERVEUR
}

enum EntrepriseType {
  COMMERCANT
  FOURNISSEUR
}
enum SyncStatus {
  PENDING
  SYNCED
  FAILED
}

model User {
  id                String            @id @default(uuid())
  nom               String?
  prenom            String?
  telephone         String?
  pin               String            @default("0000")
  role              UserRole          @default(ADMIN)
  isActive          Boolean           @default(true)
  magasinId         String?
  fondcaisse        Decimal?
  email             String?
  entrepriseId      String?
  isBootstrap       Boolean           @default(false)
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  permissions       String            @default("")
  isDefaultAdmin    Boolean?          @default(false)
  annule            Boolean           @default(false)
  
  // Champs de synchronisation
  syncId            String?           @unique @map("sync_id")
  lastSyncedAt      DateTime?         @map("last_synced_at")
  syncStatus        SyncStatus        @default(PENDING) @map("sync_status")
  version           Int               @default(1)
  isDeleted         Boolean           @default(false) @map("is_deleted")
  caisseId          String            @map("caisse_id")
  
  // Relations
  entreprise        Entreprise?       @relation(fields: [entrepriseId], references: [id])
  magasin           Magasin?          @relation("UserMagasinEmployees", fields: [magasinId], references: [id], onDelete: SetNull)
  magasins          Magasin[]         @relation("UserMagasins")
  createdCategories Categorie[]       @relation("CategorieCreatedBy")
  updatedCategories Categorie[]       @relation("CategorieUpdatedBy")
  printer           Printer?          @relation
  assignedTables    Table[]           @relation("TableServer")
  commandes         Commande[]
  usedTicketRestos  UsedTicketResto[] @relation("UserToUsedTicketResto")
  retours           Retour[]
  ventes            Vente[]

  @@unique([pin])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Entreprise {
  id                  String               @id @default(uuid())
  nom                 String?
  denomination        String?
  matriculeFiscale    String?
  adresse             String?
  telephone           String?
  logo                String?
  email               String?
  region              String?
  ville               String?
  pays                String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  type                EntrepriseType       @default(FOURNISSEUR)
  hasEpicerieModule   Boolean              @default(false)
  hasRestaurantModule Boolean              @default(false)
  secteurActivite     String?
  
  // Champs de synchronisation
  syncId              String?              @unique @map("sync_id")
  lastSyncedAt        DateTime?            @map("last_synced_at")
  syncStatus          SyncStatus           @default(PENDING) @map("sync_status")
  version             Int                  @default(1)
  isDeleted           Boolean              @default(false) @map("is_deleted")
  caisseId            String               @map("caisse_id")
  
  // Relations
  User                User[]
  categories          Categorie[]
  produits            Produit[]
  magasins            Magasin[]
  magasinProduits     MagasinProduit[]
  accs                Acc[]
  inventaires         Inventaire[]
  mouvementStocks     MouvementStock[]
  typeCharges         TypeCharge[]
  charges             Charge[]
  factures            Facture[]
  ventesFactures      VentesFacture[]
  achatFournisseurs   AchatFournisseur[]
  entrees             Entree[]
  myFactures          MyFacture[]
  myFactureAdresses   MyFactureAdresse[]
  myFactureEmails     MyFactureEmail[]
  myFactureTelephones MyFactureTelephone[]
  myFactureMobiles    MyFactureMobile[]
  balanceConfigs      BalanceConfig[]
  printers            Printer[]
  tables              Table[]
  floorPlans          FloorPlan[]
  commandes           Commande[]
  ventes              Vente[]
  remiseQRConfigs     RemiseQRConfig[]
  ticketrestos        TicketResto[]
  usedTicketRestos    UsedTicketResto[]
  fournisseurs        Fournisseur[]
  clients             Client[]
  retours             Retour[]
  retourLignes        RetourLigne[]
  paiements           Paiement[]

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Categorie {
  id                String     @id @default(uuid())
  nom               String
  showInPos         Boolean    @default(false)
  isDefaultOperator Boolean    @default(false)
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  createdById       String?
  updatedById       String?
  
  // Champs de synchronisation
  syncId            String?    @unique @map("sync_id")
  lastSyncedAt      DateTime?  @map("last_synced_at")
  syncStatus        SyncStatus @default(PENDING) @map("sync_status")
  version           Int        @default(1)
  isDeleted         Boolean    @default(false) @map("is_deleted")
  caisseId          String     @map("caisse_id")
  
  // Relations
  createdBy         User?      @relation("CategorieCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  updatedBy         User?      @relation("CategorieUpdatedBy", fields: [updatedById], references: [id], onDelete: SetNull)
  produits          Produit[]
  entrepriseId      String
  entreprise        Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([nom])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Lot {
  id        String  @id @default(uuid())
  quantite  Float
  price     Decimal
  produitId String
  
  // Champs de synchronisation
  syncId    String? @unique @map("sync_id")
  lastSyncedAt DateTime? @map("last_synced_at")
  syncStatus SyncStatus @default(PENDING) @map("sync_status")
  version   Int      @default(1)
  isDeleted Boolean  @default(false) @map("is_deleted")
  caisseId  String   @map("caisse_id")
  
  // Relations
  produit   Produit @relation(fields: [produitId], references: [id])

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Magasin {
  id              String           @id @default(uuid())
  nom             String
  adresse         String?
  secteurActivite String
  region          String
  ville           String
  pays            String
  responsableId   String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Champs de synchronisation
  syncId          String?          @unique @map("sync_id")
  lastSyncedAt    DateTime?        @map("last_synced_at")
  syncStatus      SyncStatus       @default(PENDING) @map("sync_status")
  version         Int              @default(1)
  isDeleted       Boolean          @default(false) @map("is_deleted")
  caisseId        String           @map("caisse_id")
  
  // Relations
  responsable     User             @relation("UserMagasins", fields: [responsableId], references: [id], onDelete: Cascade)
  employees       User[]           @relation("UserMagasinEmployees")
  magasinProduits MagasinProduit[]
  entrepriseId    String?
  entreprise      Entreprise?      @relation(fields: [entrepriseId], references: [id])
  productVariantStocks ProductVariantStock[]

  @@unique([nom])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model MagasinProduit {
  id            String     @id @default(uuid())
  produitId     String
  magasinId     String
  quantite      Float
  stockInitial  Float
  stockSecurite Float?
  active        Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId        String?    @unique @map("sync_id")
  lastSyncedAt  DateTime?  @map("last_synced_at")
  syncStatus    SyncStatus @default(PENDING) @map("sync_status")
  version       Int        @default(1)
  isDeleted     Boolean    @default(false) @map("is_deleted")
  caisseId      String     @map("caisse_id")
  
  // Relations
  produit       Produit    @relation(fields: [produitId], references: [id], onDelete: Cascade)
  magasin       Magasin    @relation(fields: [magasinId], references: [id], onDelete: Cascade)
  entrepriseId  String
  entreprise    Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([produitId, magasinId])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Inventaire {
  id           String     @id @default(uuid())
  codeBarre    String
  designation  String
  quantite     Float
  responsable  String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Acc {
  id           String     @id @default(uuid())
  codeBarre    String
  designation  String
  quantite     Float
  responsable  String
  remarque     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model MouvementStock {
  id                String     @id @default(uuid())
  date              DateTime
  codeBarre         String
  designation       String
  stockInitial      Float
  stockSecurite     Float?
  achats            Float
  ventes            Float
  acc               Float
  retour            Float      @default(0)
  stockFinalTheoric Float
  stockFinalReal    Float?
  ecart             Float?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId            String?    @unique @map("sync_id")
  lastSyncedAt      DateTime?  @map("last_synced_at")
  syncStatus        SyncStatus @default(PENDING) @map("sync_status")
  version           Int        @default(1)
  isDeleted         Boolean    @default(false) @map("is_deleted")
  caisseId          String     @map("caisse_id")
  
  // Relations
  entrepriseId      String
  entreprise        Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([date, codeBarre])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model TypeCharge {
  id           String     @id @default(uuid())
  nom          String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  charges      Charge[]   @relation("ChargeToTypeCharge")
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([nom])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Charge {
  id                   String     @id @default(uuid())
  typeChargeId         String
  montant              Decimal
  dateEcheance         DateTime
  datePaiement         DateTime?
  dateDebutRepartition DateTime
  dateFinRepartition   DateTime
  paye                 Boolean    @default(false)
  createdAt            DateTime   @default(now())
  updatedAt            DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId               String?    @unique @map("sync_id")
  lastSyncedAt         DateTime?  @map("last_synced_at")
  syncStatus           SyncStatus @default(PENDING) @map("sync_status")
  version              Int        @default(1)
  isDeleted            Boolean    @default(false) @map("is_deleted")
  caisseId             String     @map("caisse_id")
  
  // Relations
  typeCharge           TypeCharge @relation("ChargeToTypeCharge", fields: [typeChargeId], references: [id], onDelete: Restrict)
  entrepriseId         String
  entreprise           Entreprise @relation(fields: [entrepriseId], references: [id])

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

enum FactureType {
  FACTURE
  BDC
  DEV
}

model Facture {
  id                     String          @id @default(uuid())
  type                   FactureType
  num                    String          @unique(map: "UniqueFactureNum")
  dateEmission           DateTime        @default(now())
  dateEcheance           DateTime
  denominationClient     String
  matriculeFiscaleClient String?
  adresseClient          String
  clientTelephone        String?
  totalHT                Decimal
  totalTVA               Decimal
  timbreFiscal           Decimal?
  remise                 Decimal?        @default(0)
  totalNet               Decimal
  denomination           String
  matriculeFiscale       String
  banque                 String
  rib                    String
  logo                   String?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  
  // Champs de synchronisation
  syncId                 String?         @unique @map("sync_id")
  lastSyncedAt           DateTime?       @map("last_synced_at")
  syncStatus             SyncStatus      @default(PENDING) @map("sync_status")
  version                Int             @default(1)
  isDeleted              Boolean         @default(false) @map("is_deleted")
  caisseId               String          @map("caisse_id")
  
  // Relations
  ventesFactures         VentesFacture[] @relation("FactureVentes")
  entrepriseId           String
  entreprise             Entreprise      @relation(fields: [entrepriseId], references: [id])

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model VentesFacture {
  id           String     @id @default(uuid())
  factureId    String
  codeBarre    String
  designation  String
  puht         Decimal
  tva          Decimal    @default(0)
  remise       Decimal    @default(0)
  quantite     Float
  totalHT      Decimal
  totalTTC     Decimal
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  facture      Facture    @relation("FactureVentes", fields: [factureId], references: [id], onDelete: Cascade)
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model AchatFournisseur {
  id              String     @id @default(uuid())
  numeroFacture   String
  fournisseur     String
  dateEcheance    DateTime
  datePaiement    DateTime?
  pieceJointe     String?
  montantTotal    Decimal
  montantComptant Decimal?
  montantRestant  Decimal?
  remise          Decimal?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId          String?    @unique @map("sync_id")
  lastSyncedAt    DateTime?  @map("last_synced_at")
  syncStatus      SyncStatus @default(PENDING) @map("sync_status")
  version         Int        @default(1)
  isDeleted       Boolean    @default(false) @map("is_deleted")
  caisseId        String     @map("caisse_id")
  
  // Relations
  entrees         Entree[]   @relation("AchatFournisseurToEntree")
  entrepriseId    String
  entreprise      Entreprise @relation(fields: [entrepriseId], references: [id])

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Entree {
  id                 String            @id @default(uuid())
  codeBarre          String
  designation        String
  quantite           Float
  puht               Decimal
  tva                Decimal
  prixUnitaireTTC    Decimal
  prixTotalTTC       Decimal
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  
  // Champs de synchronisation
  syncId             String?           @unique @map("sync_id")
  lastSyncedAt       DateTime?         @map("last_synced_at")
  syncStatus         SyncStatus        @default(PENDING) @map("sync_status")
  version            Int               @default(1)
  isDeleted          Boolean           @default(false) @map("is_deleted")
  caisseId           String            @map("caisse_id")
  
  // Relations
  achatFournisseurId String?
  achatFournisseur   AchatFournisseur? @relation("AchatFournisseurToEntree", fields: [achatFournisseurId], references: [id], onDelete: SetNull)
  entrepriseId       String
  entreprise         Entreprise        @relation(fields: [entrepriseId], references: [id])

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model MyFacture {
  id               String               @id @default(uuid())
  denomination     String
  matriculeFiscale String
  banque           String
  rib              String
  logo             String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  
  // Champs de synchronisation
  syncId           String?              @unique @map("sync_id")
  lastSyncedAt     DateTime?            @map("last_synced_at")
  syncStatus       SyncStatus           @default(PENDING) @map("sync_status")
  version          Int                  @default(1)
  isDeleted        Boolean              @default(false) @map("is_deleted")
  caisseId         String               @map("caisse_id")
  
  // Relations
  adresses         MyFactureAdresse[]
  emails           MyFactureEmail[]
  telephones       MyFactureTelephone[]
  mobiles          MyFactureMobile[]
  entrepriseId     String
  entreprise       Entreprise           @relation(fields: [entrepriseId], references: [id])

  @@unique([denomination])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model MyFactureAdresse {
  id           String     @id @default(uuid())
  adresse      String
  myFactureId  String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  myFacture    MyFacture  @relation(fields: [myFactureId], references: [id], onDelete: Cascade)
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([adresse, myFactureId])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model MyFactureEmail {
  id           String     @id @default(uuid())
  email        String
  myFactureId  String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  myFacture    MyFacture  @relation(fields: [myFactureId], references: [id], onDelete: Cascade)
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([email, myFactureId])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model MyFactureTelephone {
  id           String     @id @default(uuid())
  numTel       String
  myFactureId  String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  myFacture    MyFacture  @relation(fields: [myFactureId], references: [id], onDelete: Cascade)
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([numTel, myFactureId])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model MyFactureMobile {
  id           String     @id @default(uuid())
  numMobile    String
  myFactureId  String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  myFacture    MyFacture  @relation(fields: [myFactureId], references: [id], onDelete: Cascade)
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([numMobile, myFactureId])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model BalanceConfig {
  id                Int        @id @default(autoincrement())
  barcodeLength     Int
  balanceCode       String
  productCodeStart  Int
  productCodeLength Int
  priceStart        Int
  priceLength       Int
  sellerStart       Int?
  sellerLength      Int?
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId            String?    @unique @map("sync_id")
  lastSyncedAt      DateTime?  @map("last_synced_at")
  syncStatus        SyncStatus @default(PENDING) @map("sync_status")
  version           Int        @default(1)
  isDeleted         Boolean    @default(false) @map("is_deleted")
  caisseId          String     @map("caisse_id")
  
  // Relations
  entrepriseId      String
  entreprise        Entreprise @relation(fields: [entrepriseId], references: [id])

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Printer {
  id           String     @id @default(uuid())
  name         String
  userId       String?    @unique
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  user         User?      @relation(fields: [userId], references: [id], onDelete: SetNull)
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([name])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Commande {
  id           String     @id @default(uuid())
  date         DateTime   @default(now())
  total        Decimal
  userId       String
  isWaiting    Boolean    @default(false)
  tpeAmount    Decimal    @default(0.000)
  especeAmount Decimal    @default(0.000)
  ticketAmount Decimal    @default(0.000)
  ticketNumber String?    @unique
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @default(now())
  tableId      String?
  remise       Decimal?   @default(0)
  chequeAmount Decimal    @default(0.000)
  annule       Boolean    @default(false)
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  user         User       @relation(fields: [userId], references: [id], onDelete: Restrict)
  ventes       Vente[]
  table        Table?     @relation("TableCommandes", fields: [tableId], references: [id], onDelete: SetNull)
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])
  retours      Retour[]   @relation("CommandeRetours")
  paiements    Paiement[]

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Vente {
  id             String        @id @default(uuid())
  codeBarre      String
  designation    String
  puht           Decimal
  tva            Decimal       @default(0)
  remise         Decimal       @default(0)
  quantite       Float
  totalHT        Decimal
  totalTTC       Decimal
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  commandeId     String
  retourQuantite Float         @default(0)
  cloturee       Boolean       @default(false)
  clotureId      Int?
  statut         String        @default("PAYEE")
  caissier       String?
  
  // Champs de synchronisation
  syncId         String?       @unique @map("sync_id")
  lastSyncedAt   DateTime?     @map("last_synced_at")
  syncStatus     SyncStatus    @default(PENDING) @map("sync_status")
  version        Int           @default(1)
  isDeleted      Boolean       @default(false) @map("is_deleted")
  caisseId       String        @map("caisse_id")
  
  // Relations
  ticketsRemise  TicketRemiseQR[]
  commande       Commande      @relation(fields: [commandeId], references: [id])
  entrepriseId   String
  entreprise     Entreprise    @relation(fields: [entrepriseId], references: [id])
  retourLignes   RetourLigne[]
  userId         String?
  user           User?         @relation(fields: [userId], references: [id])
  paiements      Paiement[]

  @@index([caissier])
  @@index([statut])
  @@index([createdAt])
  @@index([cloturee])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Retour {
  id           String        @id @default(cuid())
  commandeId   String
  totalRetour  Float
  userId       String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  // Champs de synchronisation
  syncId       String?       @unique @map("sync_id")
  lastSyncedAt DateTime?     @map("last_synced_at")
  syncStatus   SyncStatus    @default(PENDING) @map("sync_status")
  version      Int           @default(1)
  isDeleted    Boolean       @default(false) @map("is_deleted")
  caisseId     String        @map("caisse_id")
  
  // Relations
  commande     Commande      @relation("CommandeRetours", fields: [commandeId], references: [id])
  entrepriseId String
  entreprise   Entreprise    @relation(fields: [entrepriseId], references: [id])
  user         User          @relation(fields: [userId], references: [id])
  lignes       RetourLigne[]

  @@index([commandeId])
  @@index([entrepriseId])
  @@index([userId])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model RetourLigne {
  id           String     @id @default(uuid())
  venteId      String
  quantite     Float
  montant      Decimal
  createdAt    DateTime   @default(now())
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  vente        Vente      @relation(fields: [venteId], references: [id], onDelete: Cascade)
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])
  retour       Retour?    @relation(fields: [retourId], references: [id], onDelete: Cascade)
  retourId     String?

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Table {
  id           String     @id @default(uuid())
  number       String
  serverId     String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  floorPlanId  String?
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  server       User?      @relation("TableServer", fields: [serverId], references: [id], onDelete: SetNull)
  commandes    Commande[] @relation("TableCommandes")
  floorPlan    FloorPlan? @relation("FloorPlanTables", fields: [floorPlanId], references: [id], onDelete: SetNull)
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([number])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model FloorPlan {
  id           String     @id @default(uuid())
  name         String
  elements     Json
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  tables       Table[]    @relation("FloorPlanTables")
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([name])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model TicketResto {
  id           String     @id @default(uuid())
  fournisseur  String
  codeInterne  String
  pourcentage  Float?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])

  @@unique([codeInterne])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model UsedTicketResto {
  id           String     @id @default(uuid())
  codeBarre    String     @unique
  createdAt    DateTime   @default(now())
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  entrepriseId String
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  userId       String?
  user         User?      @relation("UserToUsedTicketResto", fields: [userId], references: [id], onDelete: SetNull)

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Fournisseur {
  id           String     @id @default(uuid())
  mails        String
  fixedTel     String
  mobileTel    String
  denomination String     @unique
  matricule    String
  secteur      String
  rib          String
  addresses    String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])
  entrepriseId String

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Client {
  id           String     @id @default(uuid())
  nom          String
  prenom       String
  cin          Int
  email        String?
  address      String?
  tel          String     @unique
  credit       Float      @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  
  // Champs de synchronisation
  syncId       String?    @unique @map("sync_id")
  lastSyncedAt DateTime?  @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int        @default(1)
  isDeleted    Boolean    @default(false) @map("is_deleted")
  caisseId     String     @map("caisse_id")
  
  // Relations
  entreprise   Entreprise @relation(fields: [entrepriseId], references: [id])
  entrepriseId String

  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model ClotureJour {
  id                     Int                     @id @default(autoincrement())
  dateFermeture          DateTime
  heureFermeture         String?
  caissierResponsable    String
  chiffreAffaires        Float                   @default(0)
  totalEncaissements     Float                   @default(0)
  totalAchat             Float                   @default(0)
  totalCharge            Float                   @default(0)
  totalAcc               Float                   @default(0)
  totalRemises           Float                   @default(0)
  totalRetours           Float                   @default(0)
  totalNet               Float                   @default(0)
  nombreVentes           Int                     @default(0)
  tvaCollecte            Float                   @default(0)
  fondCaisseInitial      Float                   @default(0)
  totalEspecesEncaissées Float                   @default(0)
  totalEspecesSorties    Float                   @default(0)
  totalEspecesEntree     Float                   @default(0)
  totalEspecesFinalAttendu Float                 @default(0)
  statut                 String                  @default("TERMINEE")
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  
  // Champs de synchronisation
  syncId                 String?                 @unique @map("sync_id")
  lastSyncedAt           DateTime?               @map("last_synced_at")
  syncStatus             SyncStatus              @default(PENDING) @map("sync_status")
  version                Int                     @default(1)
  isDeleted              Boolean                 @default(false) @map("is_deleted")
  caisseId               String                  @map("caisse_id")
  
  // Relations
  ventesCaissiers        VenteCaissierCloture[]
  detailPaiements        DetailPaiementCloture[]

  @@index([dateFermeture])
  @@index([caissierResponsable])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model VenteCaissierCloture {
  id                   Int     @id @default(autoincrement())
  clotureId            Int
  nomCaissier          String
  nombreVentes         Int     @default(0)
  montantTotal         Float   @default(0)
  totalRetours         Float   @default(0)
  fondCaisse           Float   @default(0)
  totalRemises         Float   @default(0)
  totalNet             Float   @default(0)
  totalEncaissements   Float   @default(0)
  paiementsEspeces     Float   @default(0)
  paiementsCarte       Float   @default(0)
  paiementsCheque      Float   @default(0)
  paiementsTicket      Float   @default(0)
  
  // Champs de synchronisation
  syncId               String? @unique @map("sync_id")
  lastSyncedAt         DateTime? @map("last_synced_at")
  syncStatus           SyncStatus @default(PENDING) @map("sync_status")
  version              Int     @default(1)
  isDeleted            Boolean @default(false) @map("is_deleted")
  caisseId             String  @map("caisse_id")
  
  // Relations
  cloture              ClotureJour @relation(fields: [clotureId], references: [id], onDelete: Cascade)

  @@index([clotureId])
  @@index([nomCaissier])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model DetailPaiementCloture {
  id           Int     @id @default(autoincrement())
  clotureId    Int
  typePaiement String
  montant      Float   @default(0)
  
  // Champs de synchronisation
  syncId       String? @unique @map("sync_id")
  lastSyncedAt DateTime? @map("last_synced_at")
  syncStatus   SyncStatus @default(PENDING) @map("sync_status")
  version      Int     @default(1)
  isDeleted    Boolean @default(false) @map("is_deleted")
  caisseId     String  @map("caisse_id")
  
  // Relations
  cloture      ClotureJour @relation(fields: [clotureId], references: [id], onDelete: Cascade)

  @@index([clotureId])
  @@index([typePaiement])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model Paiement {
  id             String    @id @default(uuid())
  type           String
  montant        Decimal
  venteId        String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  // Champs de synchronisation
  syncId         String?   @unique @map("sync_id")
  lastSyncedAt   DateTime? @map("last_synced_at")
  syncStatus     SyncStatus @default(PENDING) @map("sync_status")
  version        Int       @default(1)
  isDeleted      Boolean   @default(false) @map("is_deleted")
  caisseId       String    @map("caisse_id")
  
  // Relations
  vente          Vente     @relation(fields: [venteId], references: [id], onDelete: Cascade)
  commande       Commande? @relation(fields: [commandeId], references: [id])
  commandeId     String?
  entrepriseId   String
  entreprise     Entreprise @relation(fields: [entrepriseId], references: [id])
  @@index([venteId])
  @@index([type])
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

enum ProductType {
  POS
  MAGASIN
}

model Produit {
  id                String        @id @default(uuid())
  codeBarre         String        @unique
  designation       String
  parentId          String?
  categorieId       String
  puht              Decimal
  tva               Decimal       @default(0)
  remise            Decimal       @default(0)
  dateDebutRemise   DateTime?
  dateFinRemise     DateTime?
  stockInitial      Float
  quantite          Float         @default(1)
  stockSecurite     Float?
  featuredOnPos     Boolean       @default(false)
  active            Boolean       @default(true)
  isDefaultOperator Boolean       @default(false)
  type              ProductType   @default(MAGASIN)
  imagePath         String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  // Champs de synchronisation
  syncId            String?       @unique @map("sync_id")
  lastSyncedAt      DateTime?     @map("last_synced_at")
  syncStatus        SyncStatus    @default(PENDING) @map("sync_status")
  version           Int           @default(1)
  isDeleted         Boolean       @default(false) @map("is_deleted")
  caisseId          String        @map("caisse_id")
  
  // Relations
  parent            Produit?      @relation("ProductParent", fields: [parentId], references: [id])
  children          Produit[]     @relation("ProductParent")
  categorie         Categorie     @relation(fields: [categorieId], references: [id], onDelete: Restrict)
  entrepriseId      String
  entreprise        Entreprise    @relation(fields: [entrepriseId], references: [id])
  magasinProduits   MagasinProduit[]
  Lot               Lot[]
  variants          ProductVariant[]

  @@map("produits")
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model VariantFamily {
  id          Int            @id @default(autoincrement())
  name        String         @unique
  description String?
  code        String         @unique
  isRequired  Boolean        @default(false)
  sortOrder   Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  
  // Champs de synchronisation
  syncId      String?        @unique @map("sync_id")
  lastSyncedAt DateTime?     @map("last_synced_at")
  syncStatus  SyncStatus     @default(PENDING) @map("sync_status")
  version     Int            @default(1)
  isDeleted   Boolean        @default(false) @map("is_deleted")
  caisseId    String         @map("caisse_id")
  
  // Relations
  values      VariantValue[]

  @@map("variant_families")
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model VariantValue {
  id              Int              @id @default(autoincrement())
  value           String
  sortOrder       Int              @default(0)
  variantFamilyId Int?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Champs de synchronisation
  syncId          String?          @unique @map("sync_id")
  lastSyncedAt    DateTime?        @map("last_synced_at")
  syncStatus      SyncStatus       @default(PENDING) @map("sync_status")
  version         Int              @default(1)
  isDeleted       Boolean          @default(false) @map("is_deleted")
  caisseId        String           @map("caisse_id")
  
  // Relations
  variantFamily   VariantFamily?   @relation(fields: [variantFamilyId], references: [id], onDelete: Cascade)
  productVariants ProductVariant[] @relation("variant_values")

  @@unique([variantFamilyId, value])
  @@map("variant_values")
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model ProductVariant {
  id                 Int                     @id @default(autoincrement())
  productId          String
  sku                String?                 @unique
  name               String?
  priceAdjustment    Float                   @default(0)
  costAdjustment     Float                   @default(0)
  isActive           Boolean                 @default(true)
  createdAt          DateTime                @default(now())
  updatedAt          DateTime                @updatedAt
  
  // Champs de synchronisation
  syncId             String?                 @unique @map("sync_id")
  lastSyncedAt       DateTime?               @map("last_synced_at")
  syncStatus         SyncStatus              @default(PENDING) @map("sync_status")
  version            Int                     @default(1)
  isDeleted          Boolean                 @default(false) @map("is_deleted")
  caisseId           String                  @map("caisse_id")
  
  // Relations
  product            Produit                 @relation(fields: [productId], references: [id], onDelete: Cascade)
  values             VariantValue[]          @relation("variant_values")
  stocks             ProductVariantStock[]

  @@map("product_variants")
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model ProductVariantStock {
  id                Int            @id @default(autoincrement())
  productVariantId  Int
  magasinId         String
  quantity          Int            @default(0)
  minStock          Int            @default(0)
  maxStock          Int?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @default(now()) @updatedAt
  
  // Champs de synchronisation
  syncId            String?        @unique @map("sync_id")
  lastSyncedAt      DateTime?      @map("last_synced_at")
  syncStatus        SyncStatus     @default(PENDING) @map("sync_status")
  version           Int            @default(1)
  isDeleted         Boolean        @default(false) @map("is_deleted")
  caisseId          String         @map("caisse_id")
  
  // Relations
  productVariant    ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  magasin           Magasin        @relation(fields: [magasinId], references: [id])

  @@unique([productVariantId, magasinId])
  @@map("product_variant_stocks")
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model RemiseQRConfig {
  id           String        @id @default(uuid())
  entrepriseId String
  pourcentage  Float
  joursValidite Int
  isActive     Boolean       @default(true)
  message      String?       @default("Revenez prochainement pour bénéficier d'une remise!")
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  
  // Champs de synchronisation
  syncId       String?       @unique @map("sync_id")
  lastSyncedAt DateTime?     @map("last_synced_at")
  syncStatus   SyncStatus    @default(PENDING) @map("sync_status")
  version      Int           @default(1)
  isDeleted    Boolean       @default(false) @map("is_deleted")
  caisseId     String        @map("caisse_id")
  
  // Relations
  entreprise   Entreprise    @relation(fields: [entrepriseId], references: [id], onDelete: Cascade)
  ticketsRemise TicketRemiseQR[]

  @@unique([entrepriseId, isActive])
  @@map("remise_qr_configs")
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model TicketRemiseQR {
  id              String        @id @default(uuid())
  code            String        @unique
  configId        String
  venteId         String?
  pourcentage     Float
  dateExpiration  DateTime
  dateUtilisation DateTime?
  isUsed          Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Champs de synchronisation
  syncId          String?       @unique @map("sync_id")
  lastSyncedAt    DateTime?     @map("last_synced_at")
  syncStatus      SyncStatus    @default(PENDING) @map("sync_status")
  version         Int           @default(1)
  isDeleted       Boolean       @default(false) @map("is_deleted")
  caisseId        String        @map("caisse_id")
  
  // Relations
  config          RemiseQRConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  vente           Vente?        @relation(fields: [venteId], references: [id], onDelete: SetNull)

  @@index([code])
  @@index([venteId])
  @@index([dateExpiration])
  @@index([isUsed])
  @@map("ticket_remise_qr")
  @@index([syncId])
  @@index([syncStatus])
  @@index([caisseId])
  @@index([lastSyncedAt])
}

model SyncQueue {
  id           String    @id @default(uuid())
  tableName    String    @map("table_name")
  operation    String    // CREATE, UPDATE, DELETE
  data         Json
  localId      String    @map("local_id")
  status       String    // PENDING, PROCESSING, COMPLETED, FAILED
  retries      Int       @default(0)
  error        String?
  timestamp    DateTime  @default(now())
  caisseId     String    @map("caisse_id")
  
  @@index([status])
  @@index([timestamp])
  @@index([caisseId])
  @@index([tableName])
}

model SyncConflict {
  id           String    @id @default(uuid())
  caisseId     String    @map("caisse_id")
  tableName    String    @map("table_name")
  recordId     String    @map("record_id")
  localData    Json      @map("local_data")
  serverData   Json      @map("server_data")
  resolution   String?   // CLIENT_WINS, SERVER_WINS, MERGED
  resolvedAt   DateTime? @map("resolved_at")
  resolvedBy   String?   @map("resolved_by")
  createdAt    DateTime  @default(now()) @map("created_at")
  
  @@index([caisseId])
  @@index([tableName, recordId])
  @@index([resolution])
}

model SyncLog{
  id           String    @id @default(uuid())
  caisseId     String    @map("caisse_id")
  operation    String    // PUSH, PULL
  timestamp    DateTime  @default(now())
  status       String    // SUCCESS, ERROR
  details      Json?
  
  @@unique([caisseId, operation])
  @@index([caisseId])
  @@index([timestamp])
}
model Caisse {
  id          String   @id @default(uuid())
  name        String
  ip          String
  port        Int      @default(3000)
  macAddress  String?
  status      String   @default("offline")
  lastSync    DateTime?
  isActive    Boolean  @default(true)
  isCentral   Boolean  @default(false)
  version     String?
  storeId     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([ip, port])
  @@index([status])
  @@index([isCentral])
}